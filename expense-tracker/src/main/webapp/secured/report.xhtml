<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:rich="http://richfaces.org/rich"
                template="/resources/template/layout.xhtml">

    <f:metadata>
        <f:event type="preRenderView" listener="#{expenseReportController.doRefresh()}" />
    </f:metadata>
    
    <ui:define name="content">
        <h:form id="reportForm">
            <rich:panel header="Report">
                <h:panelGrid id="reportPanel" columns="2" border="0">
                    <h:outputLabel for="reportName" value="Name" />
                    <rich:inplaceInput value="#{selectedReport.name}" disabled="#{not rules.canEditReport(selectedReport)}" defaultLabel="Name" id="reportName" />

                    <h:outputLabel for="reportStatus" value="Status" />
                    <h:outputText value="#{selectedReport.status}" id="reportStatus" />

                    <h:outputLabel for="reportAssignee" value="Assignee" />
                    <h:outputText value="#{selectedReport.assignee.fullName}" id="reportAssignee" />

                    <h:outputLabel for="reportReporter" value="Reporter" />
                    <h:outputText value="#{selectedReport.reporter.fullName}" id="reportReporter" />

                    <h:outputLabel for="reportDescription" value="Description" />
                    <h:inputTextarea value="#{selectedReport.description}" id="reportDescription" disabled="#{not rules.canEditReport(selectedReport)}" />

                    <h:outputLabel for="reportLastChange" value="Last changed" />
                    <h:panelGroup id="reportLastChange">
                        <h:outputText value="#{selectedReport.lastChangeDate}" converter="#{customDateTimeConverter}" id="reportLastChangeDate"/> by 
                        <h:outputText value="#{selectedReport.lastChangedBy.fullName}" id="reportLastChangeBy"/>
                    </h:panelGroup>

                    <f:facet name="footer">
                        <h:panelGroup rendered="#{rules.canEditReport(selectedReport)}">
                            <h:commandButton value="Save" action="#{expenseReportController.save()}" id="saveBtn"/>
                            <h:commandButton value="Cancel" action="#{expenseReportController.cancel()}" immediate="true" id="cancelBtn"/>
                        </h:panelGroup>
                    </f:facet>
                </h:panelGrid>
            </rich:panel>
        </h:form>

        <h:form id="reimbursementsForm">
            <!-- REIMBURSEMENTS -->
            <rich:panel header="Reimbursements" rendered="#{not expenseReportController.isNew(selectedReport)}">
                <rich:dataTable value="#{selectedReport.reimbursements}" var="reimbursement" rendered="#{not empty selectedReport.reimbursements}" id="reimbursementsTable">
                    <rich:column id="date">
                        <f:facet name="header">Date</f:facet>
                        <h:outputText value="#{reimbursement.date}" converter="#{customDateTimeConverter}" />
                    </rich:column>

                    <rich:column id="creator">
                        <f:facet name="header">Creator</f:facet>
                            #{reimbursement.creator.fullName}
                    </rich:column>

                    <rich:column id="value">
                        <f:facet name="header">Value</f:facet>
                        <h:outputText value="#{reimbursement.value}">
                            <f:convertNumber maxFractionDigits="0" currencySymbol="$" type="currency"/>
                        </h:outputText>
                    </rich:column>

                    <rich:column id="actions">
                        <f:facet name="header">Action</f:facet>
                        <h:commandButton action="#{reimbursementController.edit(reimbursement)}" rendered="#{rules.canEditReimbursements(selectedReport)}" id="edit" value="Edit" />
                        <h:commandButton action="#{reimbursementController.delete(reimbursement)}" rendered="#{rules.canEditReimbursements(selectedReport)}" id="delete" value="Delete" />
                    </rich:column>

                    <f:facet name="footer">
                        <rich:columnGroup>
                            <rich:column>Reimbursements total:</rich:column>
                            <rich:column colspan="5" id="total">
                                <h:outputText value="#{expenseReportController.getReimbursementsTotal(selectedReport)}">
                                    <f:convertNumber maxFractionDigits="0" currencySymbol="$" type="currency"/>
                                </h:outputText>
                            </rich:column>
                        </rich:columnGroup>
                    </f:facet>
                </rich:dataTable>

                <h:panelGroup rendered="#{rules.canEditReimbursements(selectedReport)}">
                    <h:commandButton action="#{reimbursementController.create(selectedReport)}" value="Add reimbursement" id="addReimbursementBtn"/>
                </h:panelGroup>
            </rich:panel>
        </h:form>

        <h:form id="expensesForm">
            <!-- EXPENSES -->
            <rich:panel header="Expenses" rendered="#{not expenseReportController.isNew(selectedReport)}">
                <rich:dataTable value="#{selectedReport.expenses}" rendered="#{not empty selectedReport.expenses}" var="expense"  id="expensesTable">

                    <rich:column id="date">
                        <f:facet name="header">Date</f:facet>
                        <h:outputText value="#{expense.date}" converter="#{customDateTimeConverter}" />
                    </rich:column>

                    <rich:column id="purpose">
                        <f:facet name="header">Purpose</f:facet>
                            #{expense.purpose.name}
                    </rich:column>

                    <rich:column id="receipt">
                        <f:facet name="header">Receipt</f:facet>
                        <h:commandLink action="#{receiptController.edit(expense.receipt)}">
                            #{expense.receipt.documentName}
                        </h:commandLink>
                    </rich:column>

                    <rich:column id="value">
                        <f:facet name="header">Value</f:facet>
                        <h:outputText value="#{expense.value}">
                            <f:convertNumber maxFractionDigits="0" currencySymbol="$" type="currency"/>
                        </h:outputText>
                    </rich:column>

                    <rich:column id="actions">
                        <f:facet name="header">Action</f:facet>
                        <h:commandButton action="#{expenseController.edit(expense)}" rendered="#{rules.canEditExpenses(selectedReport)}" value="Edit" id="edit" />
                        <h:commandButton action="#{expenseController.delete(expense)}" rendered="#{rules.canEditExpenses(selectedReport)}" value="Delete" id="delete" />
                    </rich:column>

                    <f:facet name="footer">
                        <rich:columnGroup>
                            <rich:column>Expenses total:</rich:column>
                            <rich:column colspan="5" id="total">
                                <h:outputText value="#{expenseReportController.getExpensesTotal(selectedReport)}">
                                    <f:convertNumber maxFractionDigits="0" currencySymbol="$" type="currency"/>
                                </h:outputText>
                            </rich:column>
                        </rich:columnGroup>
                    </f:facet>
                </rich:dataTable>
                <h:panelGroup rendered="#{rules.canEditExpenses(selectedReport)}">
                    <h:commandButton action="#{expenseController.create(selectedReport)}" value="Add Expense" id="addExpenseBtn"/>
                </h:panelGroup>
            </rich:panel>

        </h:form>

        <rich:panel header="Report Balance">
            <h:outputText value="#{expenseReportController.getReportTotal(selectedReport)}" id="reportBalance">
                <f:convertNumber maxFractionDigits="0" currencySymbol="$" type="currency"/>
            </h:outputText>
        </rich:panel>

        <h:form id="receiptsForm">
            <!-- RECEIPTS -->
            <rich:panel header="Receipts" rendered="#{not expenseReportController.isNew(selectedReport)}">
                <rich:dataTable value="#{expenseReportController.reportReceipts}" rendered="#{not empty selectedReport.receipts}" var="receipt" id="receiptsTable">

                    <rich:column id="name">
                        <f:facet name="header">Name</f:facet>                        
                            #{receipt.documentName}
                    </rich:column>

                    <rich:column id="importDate">
                        <f:facet name="header">Import Date</f:facet>
                        <h:outputText value="#{receipt.importDate}" converter="#{customDateTimeConverter}" />
                    </rich:column>

                    <rich:column id="importedBy">
                        <f:facet name="header">Imported By</f:facet>
                            #{receipt.importedBy.fullName}
                    </rich:column>

                    <rich:column id="actions">
                        <f:facet name="header">Action</f:facet>
                        <h:commandButton action="#{receiptController.edit(receipt)}" rendered="#{rules.canEditReceipts(selectedReport)}" value="Show" id="show" />
                        <h:commandButton action="#{receiptController.delete(receipt)}" rendered="#{rules.canEditReceipts(selectedReport)}" value="Delete" id="delete" />
                    </rich:column>

                </rich:dataTable>
                <h:panelGroup rendered="#{rules.canEditReceipts(selectedReport)}">
                    <h:commandButton action="#{receiptController.create(selectedReport)}" value="Add Receipt" id="addReceiptBtn"/>
                </h:panelGroup>
            </rich:panel>

        </h:form>

        <h:form id="actionsForm">
            <rich:panel header="Report actions" rendered="#{not expenseReportController.isNew(selectedReport)}">
                <!-- Reporter options -->
                <h:commandButton action="#{expenseReportController.open()}" rendered="#{rules.canBeOpened(selectedReport)}" value="Reopen" id="reopen" />
                <h:commandButton action="#{expenseReportController.submit()}" rendered="#{rules.canBeSubmitted(selectedReport)}" value="Submit" id="submit" />

                <!-- Assignee options -->
                <h:panelGroup>
                    <h:commandButton action="#{expenseReportController.assign(currentEmployee)}" rendered="#{rules.canBeAssigned(selectedReport)}" value="Assign to me" id="assignToMe" />
                    <h:commandButton action="#{expenseReportController.unassign()}" rendered="#{rules.canBeUnassigned(selectedReport)}" value="Unassign" id="unassign" />
                    <h:commandButton action="#{expenseReportController.reject()}" rendered="#{rules.canBeRejected(selectedReport)}" value="Reject" id="reject" />
                    <h:commandButton action="#{expenseReportController.approve()}" rendered="#{rules.canBeApproved(selectedReport)}" value="Approve" id="approve" />
                    <h:commandButton action="#{expenseReportController.settle()}" rendered="#{rules.canBeSettled(selectedReport)}" value="Settle" id="settle" />
                </h:panelGroup>

            </rich:panel>
        </h:form>
    </ui:define>
</ui:composition>
